name: 安装向导打包 - Pyinstaller

permissions:
  contents: write

on:
  push:
    branches:
      - '**'        # 匹配所有分支
    tags-ignore:
      - '*'         # 忽略所有 tag 推送

jobs:
  Build-Installer:
    runs-on: windows-latest

    env:
      PYTHON_VERSION: '3.9'
      OUTPUT_DIR: 'output'
      ARTIFACT_NAME: 'Bloret-Launcher-Installer-Windows.zip'

    steps:
    - name: 检出最新版本
      uses: actions/checkout@v4

    - name: 验证安装向导资源文件路径
      run: |
        Get-ChildItem -Path .
        if (-not (Test-Path "bloret.ico")) { Write-Host "bloret.ico not found"; exit 1 }
        if (-not (Test-Path "ui")) { Write-Host "ui directory not found"; exit 1 }
        if (-not (Test-Path "requirements.txt")) { Write-Host "requirements.txt not found"; exit 1 }
        if (-not (Test-Path "page1.py")) { Write-Host "page1.py not found"; exit 1 }
        if (-not (Test-Path "page2_1.py")) { Write-Host "page2_1.py not found"; exit 1 }
        if (-not (Test-Path "page2_2.py")) { Write-Host "page2_2.py not found"; exit 1 }
        if (-not (Test-Path "page3.py")) { Write-Host "page3.py not found"; exit 1 }
      shell: pwsh

    - name: 设置 Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: 安装程序依赖和打包依赖
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install pillow
        pip install pyinstaller
    
    - name: 使用 PyInstaller 打包安装向导
      run: |
        pyinstaller --onefile --noconsole --icon=bloret.ico --name=Bloret-Launcher-Installer `
          --add-data "bloret.ico;." `
          --add-data "ui;ui" `
          --add-data "page1.py;." `
          --add-data "page2_1.py;." `
          --add-data "page2_2.py;." `
          --add-data "page3.py;." `
          --add-data "requirements.txt;." `
          --add-data "README.md;." `
          --add-data "LICENSE;." `
          --add-data "PROJECT_SUMMARY.md;." `
          --add-data "run_installer.bat;." `
          --add-data "setup.py;." `
          --hidden-import=qfluentwidgets `
          --hidden-import=PyQt6.QtCore `
          --hidden-import=PyQt6.QtGui `
          --hidden-import=PyQt6.QtWidgets `
          --hidden-import=qfluentwidgets.components `
          --hidden-import=qfluentwidgets.common `
          --hidden-import=qfluentwidgets.window `
          --hidden-import=requests `
          --collect-all qfluentwidgets `
          --paths=. `
          installer.py
      shell: pwsh

    - name: 创建安装向导输出目录
      run: |
        mkdir -p ${{ env.OUTPUT_DIR }}
        cp dist/Bloret-Launcher-Installer.exe ${{ env.OUTPUT_DIR }}/
        cp -r ui/ ${{ env.OUTPUT_DIR }}/
        cp installer.py ${{ env.OUTPUT_DIR }}/
        cp page1.py ${{ env.OUTPUT_DIR }}/
        cp page2_1.py ${{ env.OUTPUT_DIR }}/
        cp page2_2.py ${{ env.OUTPUT_DIR }}/
        cp page3.py ${{ env.OUTPUT_DIR }}/
        cp requirements.txt ${{ env.OUTPUT_DIR }}/
        cp run_installer.bat ${{ env.OUTPUT_DIR }}/
        cp setup.py ${{ env.OUTPUT_DIR }}/
        cp LICENSE ${{ env.OUTPUT_DIR }}/
        cp README.md ${{ env.OUTPUT_DIR }}/
        cp PROJECT_SUMMARY.md ${{ env.OUTPUT_DIR }}/
        cp bloret.ico ${{ env.OUTPUT_DIR }}/

    - name: 清理旧压缩包
      run: |
        if (Test-Path "${{ env.OUTPUT_DIR }}/${{ env.ARTIFACT_NAME }}") {
          Remove-Item "${{ env.OUTPUT_DIR }}/${{ env.ARTIFACT_NAME }}"
        }
      shell: pwsh

    # - name: 创建压缩包
    #   run: Compress-Archive -Path "${{ env.OUTPUT_DIR }}/*" -DestinationPath "${{ env.OUTPUT_DIR }}/${{ env.ARTIFACT_NAME }}"
    #   shell: pwsh

    - name: 上传安装向导构建产物
      uses: actions/upload-artifact@v4
      with:
        name: Bloret-Launcher-Installer-Windows
        path: dist/Bloret-Launcher-Installer.exe
  Code-Package:
    runs-on: windows-latest

    steps:
    - name: 检出最新版本
      uses: actions/checkout@v4

    - name: 创建输出目录并清理
      run: |
        # 强制创建目录并清理旧内容
        New-Item -ItemType Directory -Force -Path "output"
        Remove-Item -Path "output/*" -Recurse -ErrorAction Ignore
      shell: pwsh

    - name: 复制安装向导源代码文件
      run: |
        # 复制安装向导相关文件到 output 目录
        $filesToCopy = @(
          "installer.py",
          "page1.py",
          "page2_1.py",
          "page2_2.py", 
          "page3.py",
          "requirements.txt",
          "run_installer.bat",
          "setup.py",
          "bloret.ico",
          "LICENSE",
          "README.md",
          "PROJECT_SUMMARY.md"
        )
        
        foreach ($file in $filesToCopy) {
          if (Test-Path $file) {
            Copy-Item -Path $file -Destination "output\"
          }
        }
        
        # 复制 ui 目录
        if (Test-Path "ui") {
          Copy-Item -Path "ui" -Destination "output\" -Recurse
        }
        
        # 确保 LICENSE 文件被复制
        if (-not (Test-Path "output/LICENSE")) {
          Write-Host "LICENSE 文件未找到"
          exit 1
        }
      shell: pwsh

    - name: 创建源代码压缩包
      run: |
        # 直接压缩 output 目录内容为 Code-Package.zip
        Compress-Archive -Path "output/*" -DestinationPath "output/Code-Package.zip" -Force
      shell: pwsh

    - name: 上传源代码压缩包
      uses: actions/upload-artifact@v4
      with:
        name: Installer-Code-Package
        path: "output/Code-Package.zip"
  
  # Build-macOS:
  #   needs: Set-Version
  #   runs-on: macos-latest
  #   env:
  #     PYTHON_VERSION: '3.9'
  #     OUTPUT_DIR: 'output'
  #     ARTIFACT_NAME: 'Bloret-Launcher-macOS.zip'
  #   steps:
  #   - name: 检出最新版本
  #     uses: actions/checkout@v2
  #   - name: 验证资源文件路径
  #     run: |
  #       ls -alh .
  #       [ -f "bloret.ico" ] || (echo "bloret.ico not found" && exit 1)
  #       [ -f "config.json" ] || (echo "config.json not found" && exit 1)
  #       [ -d "ui" ] || (echo "ui directory not found" && exit 1)
  #       [ -d "lang" ] || (echo "lang directory not found" && exit 1)
  #       [ -f "cmcl.json" ] || (echo "cmcl.json not found" && exit 1)
  #       [ -f "cmcl.exe" ] || (echo "cmcl.exe not found" && exit 1)
  #       [ -f "cmcl.blank.json" ] || (echo "cmcl.blank.json not found" && exit 1)
  #       [ -f "frpc.exe" ] || (echo "frpc.exe not found" && exit 1)
  #       [ -f "frpc.toml" ] || (echo "frpc.toml not found" && exit 1)
  #       [ -f "JavaWrapper.jar" ] || (echo "JavaWrapper.jar not found" && exit 1)
  #     shell: bash
  #   - name: 设置 Python
  #     uses: actions/setup-python@v2
  #     with:
  #       python-version: ${{ env.PYTHON_VERSION }}
  #   - name: 过滤依赖
  #     run: |
  #       grep -ivE '^(pywin32|win11toast|winsdk)' requirements.txt > requirements_nopywin32.txt
  #     shell: bash
  #   - name: 安装依赖
  #     run: |
  #       python -m pip install --upgrade pip
  #       pip install -r requirements_nopywin32.txt
  #       pip install pillow pyinstaller
  #     shell: bash
  #   - name: 使用 PyInstaller 打包
  #     run: |
  #       pyinstaller --onefile --windowed --name=Bloret-Launcher \
  #         --add-data "bloret.ico:." \
  #         --add-data "config.json:." \
  #         --add-data "ui:ui" \
  #         --add-data "lang:lang" \
  #         --add-data "cmcl.json:." \
  #         --add-data "cmcl.exe:." \
  #         --add-data "cmcl.blank.json:." \
  #         --add-data "frpc.exe:." \
  #         --add-data "frpc.toml:." \
  #         --add-data "JavaWrapper.jar:." \
  #         --hidden-import=sip \
  #         --hidden-import=qfluentwidgets \
  #         --hidden-import=win11toast \
  #         --hidden-import=toml \
  #         --paths=. \
  #         Bloret-Launcher.py
  #     shell: bash

  #   - name: 创建包含其他文件夹的目录
  #     run: |
  #       mkdir -p ${{ env.OUTPUT_DIR }}
  #       cp dist/Bloret-Launcher ${{ env.OUTPUT_DIR }}/
  #       cp -r ui/ ${{ env.OUTPUT_DIR }}/
  #       cp -r lang/ ${{ env.OUTPUT_DIR }}/
  #       cp cmcl.exe ${{ env.OUTPUT_DIR }}/
  #       cp cmcl.json ${{ env.OUTPUT_DIR }}/
  #       cp cmcl.blank.json ${{ env.OUTPUT_DIR }}/
  #       cp config.json ${{ env.OUTPUT_DIR }}/
  #       cp LICENSE ${{ env.OUTPUT_DIR }}/
  #       cp servers.dat ${{ env.OUTPUT_DIR }}/ || true
  #       cp cmcl_save.json ${{ env.OUTPUT_DIR }}/ || true
  #       cp bloret.ico ${{ env.OUTPUT_DIR }}/
  #       cp frpc.exe ${{ env.OUTPUT_DIR }}/
  #       cp frpc.toml ${{ env.OUTPUT_DIR }}/
  #       cp JavaWrapper.jar ${{ env.OUTPUT_DIR }}/
  #     shell: bash
  #   - name: 清理旧压缩包
  #     run: |
  #       [ -f "${{ env.OUTPUT_DIR }}/${{ env.ARTIFACT_NAME }}" ] && rm "${{ env.OUTPUT_DIR }}/${{ env.ARTIFACT_NAME }}" || true
  #     shell: bash
  #   - name: 创建压缩包
  #     run: zip -r "${{ env.OUTPUT_DIR }}/${{ env.ARTIFACT_NAME }}" ${{ env.OUTPUT_DIR }}/*
  #     shell: bash
  #   - name: 上传构建产物
  #     uses: actions/upload-artifact@v4
  #     with:
  #       name: Bloret-Launcher-macOS
  #       path: "${{ env.OUTPUT_DIR }}/${{ env.ARTIFACT_NAME }}"
  # Build-Linux:
  #   needs: Set-Version
  #   runs-on: ubuntu-latest
  #   env:
  #     PYTHON_VERSION: '3.9'
  #     OUTPUT_DIR: 'output'
  #     ARTIFACT_NAME: 'Bloret-Launcher-Linux.zip'
  #   steps:
  #   - name: 检出最新版本
  #     uses: actions/checkout@v2
  #     with:
  #       ref: 'Windows'
  #   - name: 验证资源文件路径
  #     run: |
  #       ls -alh .
  #       [ -f "bloret.ico" ] || (echo "bloret.ico not found" && exit 1)
  #       [ -f "config.json" ] || (echo "config.json not found" && exit 1)
  #       [ -d "ui" ] || (echo "ui directory not found" && exit 1)
  #       [ -d "lang" ] || (echo "lang directory not found" && exit 1)
  #       [ -f "cmcl.json" ] || (echo "cmcl.json not found" && exit 1)
  #       [ -f "cmcl.exe" ] || (echo "cmcl.exe not found" && exit 1)
  #       [ -f "cmcl.blank.json" ] || (echo "cmcl.blank.json not found" && exit 1)
  #       [ -f "frpc.exe" ] || (echo "frpc.exe not found" && exit 1)
  #       [ -f "frpc.toml" ] || (echo "frpc.toml not found" && exit 1)
  #       [ -f "JavaWrapper.jar" ] || (echo "JavaWrapper.jar not found" && exit 1)
  #     shell: bash
  #   - name: 设置 Python
  #     uses: actions/setup-python@v2
  #     with:
  #       python-version: ${{ env.PYTHON_VERSION }}
  #   - name: 过滤依赖
  #     run: |
  #       grep -ivE '^(pywin32|win11toast|winsdk)' requirements.txt > requirements_nopywin32.txt
  #     shell: bash
  #   - name: 安装依赖
  #     run: |
  #       python -m pip install --upgrade pip
  #       pip install -r requirements_nopywin32.txt
  #       pip install pillow pyinstaller
  #     shell: bash
  #   - name: 使用 PyInstaller 打包
  #     run: |
  #       pyinstaller --onefile --windowed --name=Bloret-Launcher \
  #         --add-data "bloret.ico:." \
  #         --add-data "config.json:." \
  #         --add-data "ui:ui" \
  #         --add-data "lang:lang" \
  #         --add-data "cmcl.json:." \
  #         --add-data "cmcl.exe:." \
  #         --add-data "cmcl.blank.json:." \
  #         --add-data "frpc.exe:." \
  #         --add-data "frpc.toml:." \
  #         --add-data "JavaWrapper.jar:." \
  #         --hidden-import=sip \
  #         --hidden-import=qfluentwidgets \
  #         --hidden-import=win11toast \
  #         --hidden-import=toml \
  #         --paths=. \
  #         Bloret-Launcher.py
  #     shell: bash
  #   - name: 创建包含其他文件夹的目录
  #     run: |
  #       mkdir -p ${{ env.OUTPUT_DIR }}
  #       cp dist/Bloret-Launcher ${{ env.OUTPUT_DIR }}/
  #       cp -r ui/ ${{ env.OUTPUT_DIR }}/
  #       cp -r lang/ ${{ env.OUTPUT_DIR }}/
  #       cp cmcl.exe ${{ env.OUTPUT_DIR }}/
  #       cp cmcl.json ${{ env.OUTPUT_DIR }}/
  #       cp cmcl.blank.json ${{ env.OUTPUT_DIR }}/
  #       cp config.json ${{ env.OUTPUT_DIR }}/
  #       cp LICENSE ${{ env.OUTPUT_DIR }}/
  #       cp servers.dat ${{ env.OUTPUT_DIR }}/ || true
  #       cp cmcl_save.json ${{ env.OUTPUT_DIR }}/ || true
  #       cp bloret.ico ${{ env.OUTPUT_DIR }}/
  #       cp frpc.exe ${{ env.OUTPUT_DIR }}/
  #       cp frpc.toml ${{ env.OUTPUT_DIR }}/
  #       cp JavaWrapper.jar ${{ env.OUTPUT_DIR }}/
  #     shell: bash
  #   - name: 清理旧压缩包
  #     run: |
  #       [ -f "${{ env.OUTPUT_DIR }}/${{ env.ARTIFACT_NAME }}" ] && rm "${{ env.OUTPUT_DIR }}/${{ env.ARTIFACT_NAME }}" || true
  #     shell: bash
  #   - name: 创建压缩包
  #     run: zip -r "${{ env.OUTPUT_DIR }}/${{ env.ARTIFACT_NAME }}" ${{ env.OUTPUT_DIR }}/*
  #     shell: bash
  #   - name: 上传构建产物
  #     uses: actions/upload-artifact@v4
  #     with:
  #       name: Bloret-Launcher-Linux
  #       path: "${{ env.OUTPUT_DIR }}/${{ env.ARTIFACT_NAME }}"

  # Collect-Artifacts:
  #   needs: [Build-Windows, Build-macOS, Build-Linux]
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: 下载 Windows 构建产物
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: Bloret-Launcher
  #         path: output/all/windows
  #     - name: 下载 macOS 构建产物
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: Bloret-Launcher-macOS
  #         path: output/all/macos
  #     - name: 下载 Linux 构建产物
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: Bloret-Launcher-Linux
  #         path: output/all/linux
  #     - name: 展示收集到的产物
  #       run: |
  #         ls -alR output/all
  #     - name: 上传所有平台产物
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: Bloret-Launcher-All
  #         path: output/all/

  # release:
  #   needs: [Build, Code-Package, Build-Setup]
  #   runs-on: windows-latest
  #   env:
  #     OUTPUT_DIR: 'output'  # 定义 OUTPUT_DIR 环境变量
  #     ARTIFACT_NAME: 'Bloret-Launcher-Windows.zip'  # 定义 ARTIFACT_NAME 环境变量
  #   steps:
  #   - name: 检出代码
  #     uses: actions/checkout@v2

  #   - name: 下载构建产物
  #     uses: actions/download-artifact@v4
  #     with:
  #       name: Bloret-Launcher
  #       path: ${{ env.OUTPUT_DIR }}

  #   - name: 检查 Bloret-Launcher.zip 是否存在
  #     run: |
  #       if (-not (Test-Path "${{ env.OUTPUT_DIR }}/${{ env.ARTIFACT_NAME }}")) {
  #         Write-Host "${{ env.ARTIFACT_NAME }} not found"
  #         exit 1
  #       }
  #     shell: pwsh

  #   - name: 创建预发布版本
  #     id: create_release
  #     uses: actions/github-script@v6
  #     env:
  #       GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #     with:
  #       script: |
  #         const fs = require('fs');
  #         const path = require('path');

  #         // 读取 release.md 文件内容
  #         const releaseNotesPath = path.join(process.env.GITHUB_WORKSPACE, '.github/workflows/release.md');
  #         if (!fs.existsSync(releaseNotesPath)) {
  #           throw new Error('release.md 文件未找到');
  #         }
  #         const releaseNotes = fs.readFileSync(releaseNotesPath, 'utf8');

  #         // 创建预发布版本
  #         const { data: release } = await github.rest.repos.createRelease({
  #           owner: context.repo.owner,
  #           repo: context.repo.repo,
  #           tag_name: `v${new Date().toISOString().replace(/[-:.TZ]/g, '').slice(0, 12)}`, // 使用时间戳作为标签
  #           name: '预发布版本',
  #           body: releaseNotes,
  #           draft: false,
  #           prerelease: true
  #         });

  #         console.log('Created release:', release);

  #         // 确保生成 upload_url.txt 文件
  #         const filePath = path.join(process.env.GITHUB_WORKSPACE, 'upload_url.txt');
  #         fs.writeFileSync(filePath, release.upload_url);

  #   - name: 检查 upload_url.txt 是否存在并验证内容
  #     run: |
  #       if (-not (Test-Path "upload_url.txt")) {
  #         Write-Host "upload_url.txt 文件未找到"
  #         exit 1
  #       }
  #       $uploadUrl = Get-Content -Path "upload_url.txt" -Raw
  #       if (-not $uploadUrl) {
  #         Write-Host "upload_url.txt 内容为空"
  #         exit 1
  #       }
  #     shell: pwsh

  #   - name: 设置上传 URL 环境变量
  #     id: set_upload_url
  #     run: |
  #       $uploadUrl = Get-Content -Path "upload_url.txt" -Raw
  #       Add-Content -Path $env:GITHUB_ENV -Value "UPLOAD_URL=$uploadUrl"
  #     shell: pwsh

  #   - name: 检查上传 URL 是否有效
  #     run: |
  #       if (-not "${{ env.UPLOAD_URL }}") {
  #         Write-Host "UPLOAD_URL 未正确设置"
  #         exit 1
  #       }
  #     shell: pwsh

  #   - name: 检查构建产物是否存在
  #     run: |
  #       if (-not (Test-Path "${{ env.OUTPUT_DIR }}/${{ env.ARTIFACT_NAME }}")) {
  #         Write-Host "构建产物未找到: ${{ env.OUTPUT_DIR }}/${{ env.ARTIFACT_NAME }}"
  #         exit 1
  #       }
  #     shell: pwsh

  #   - name: 上传构建产物到预发布版本
  #     uses: actions/upload-release-asset@v1
  #     env:
  #       GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #     with:
  #       upload_url: ${{ env.UPLOAD_URL }}
  #       asset_path: ${{ env.OUTPUT_DIR }}/${{ env.ARTIFACT_NAME }}
  #       asset_name: ${{ env.ARTIFACT_NAME }}
  #       asset_content_type: application/zip